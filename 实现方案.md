体育通识教学
## 1) 总体技术路线与系统闭环

系统目标是把“结构表示 → 路线生成 → 交互调控”做成可追踪闭环。实现上固定为 6 个模块（对应论文方法小节与工程模块）：

1. **数据接入与语义切分**（课程材料/教案/历史Q&A → chunk + 元数据）
2. **知识图谱构建**（三元组抽取 → 规范化/去重/校验 → Neo4j）
3. **任务链生成器**（目标锚定 → 检索先修/技能/任务 → 拓扑排序 → G–P–F 链）
4. **RAG 内容生成器**（图检索 + 文本片段检索 → 策略化输出）
5. **双智能体调控器**（Guiding vs Structural：补桥/解释 vs 回退/简化）
6. **证据化日志与评估**（结构匹配/策略标签/目标一致性）

---
neo4j密码是yyj2002222
# ---- Qwen API Configuration ----
DASHSCOPE_API_KEY = 'sk-24b732c55ce1454187fd57c9065817d1'
BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1"
CHAT_COMPLETIONS_ENDPOINT = f"{BASE_URL}/chat/completions"

# Qwen模型配置
MODEL_NAME_CANDIDATES = [
    "qwen-plus-1127",
    # "qwen-plus-1220",
    # "qwen-plus-0723",
    # "qwen-plus-0806"
]
MODEL_NAME = MODEL_NAME_CANDIDATES[0]  # 默认使用第一个模型
TEMPERATURE = 0.1  # 较低温度以提高提取准确性
MAX_RETRY = 3
SLEEP_BETWEEN = 1.0
TIMEOUT_SEC = 300

## 2) 课程知识图谱实现方案（KG Construction）

### 2.1 图谱范围与模式设计（Schema）

固定 **5 类节点 + 5 类关系**，并在 Neo4j 中强约束（唯一键/索引），保证可复现与可审计：
（数据自行生成100条用于演示）
* **节点（Labels）**：Module、KnowledgePoint、CognitiveSkill、TeachingTask、TeachingActivity
* **关系（Rels）**：BELONGS_TO_MODULE、SUPPORTS_UNDERSTANDING、CONSTITUTES_SKILL、PREDECESSOR_TASK、DEPENDENT_TASK

**节点属性（最低可用集）**

* `id`（唯一）、`name`、`definition`、`module`（冗余字段便于过滤）、`difficulty`（可选）、`source_ref`（追溯到原始chunk/页码）

### 2.2 三阶段构建流水线

构建流程为：**LangChain 语义分段 → ChatGPT-4o 结构化三元组抽取 → 规范化/去重/校验 → Neo4j**。落地为可执行工序如下。

**阶段A：语义分段（LangChain）**

* 输入：教学材料、课程计划、历史Q&A
* 输出：`chunks.jsonl`，字段：`chunk_id, text, module_hint, objective_hint, source`
* 分段时将“章节目标/功能成分”写入元数据，保证后续抽取的可控性与一致性

**阶段B：三元组抽取（统一Prompt → ChatGPT-4o）**

* 输出强制 JSON：

  * `entities:[{id,temp_name,type,canonical_name,definition,source_chunk}]`
  * `relations:[{head,rel,tail,confidence,justification,source_chunk}]`
* 同一 chunk 执行“主抽取 + 自检补全”：自检阶段要求模型补全缺失的先修/依赖关系与关键概念定义，提升覆盖度

**阶段C：规范化、去重、语义校验（Graph Integration）**

* 规范化：同义词归并（如“最大摄氧量/VO2max”）、同名异义按 module 分区
* 去重：`(head,rel,tail)` 完全一致合并；高相似实体合并并保留 `alias`
* 校验：抽样人工复核 + 规则校验（禁止环形先修、禁止 task 依赖指向 module 等）
* 入库：Neo4j `MERGE` + 唯一约束，形成多层高连接语义网络

---

## 3) 可执行任务链生成（Task Chain: Guidance–Presentation–Feedback）

### 3.1 任务链结构

任务链以 “concept → skill → task” 组织，并固定三阶段 **Guidance–Presentation–Feedback**：

* **Guidance**：澄清目标 + 激活先备知识
* **Presentation**：讲解关键概念/技能点 + 示例支撑
* **Feedback**：记录学习表现与偏差信号，作为后续调控证据入口

### 3.2 生成算法（工程可实现）

输入：`target_objective`（目标）、`learner_state`（可选：基础、偏好、已学节点）
输出：`task_chain`（有序节点序列 + 每节点三阶段脚本）

具体步骤如下：

1. **目标锚定**：在图中定位目标对应的 TeachingTask/Skill 节点
2. **图遍历检索**：检索其先修概念、支撑技能、关联任务，并沿 PREDECESSOR/DEPENDENT 拉出可达子图
3. **排序**：对任务子图做拓扑排序以保证先修满足；对于跨模块迁移任务，输出分支但保持依赖可满足
4. **模板化实例化**：对每个任务节点生成 G–P–F 三段脚本，脚本由模板库实例化，并携带证据引用与节点覆盖标注

---

## 4) 双智能体调控器（Dual-Agent Controller）

系统包含两类调控取向：

* **Guiding agent**：误解/跳任务时插入“补桥节点”，并解释转场因果以恢复可学性
* **Structural agent**：目标含糊/对话漂移时通过回退主路径与提示简化维持路线可控性

### 4.1 统一的调控动作集合（可审计）

智能体输出拆分为 **(A) 路径动作** 与 **(B) 教学话语**。路径动作只能从有限集合中选择，用于策略统计与复现：

* `INSERT_BRIDGE(node_id, reason)`：插入必要补桥节点
* `BACKTRACK(to_node_id, reason)`：回退到先修节点
* `SIMPLIFY_PROMPT(level)`：压缩提问/减少分支
* `LOCAL_REORDER(window)`：在依赖允许范围内局部重排
* `CONTINUE(next_node_id)`：维持主路径推进

### 4.2 触发条件（场景识别）

采用“规则优先 + LLM 判别兜底”的识别方式，对齐三类偏离场景：

* **ambiguous goals**：用户目标无法映射到图中具体 task/skill 或多目标冲突
* **knowledge misunderstandings**：反馈阶段出现关键概念错误、机制链断裂或定义混淆
* **cross-task jumping**：输入显示明显跳到非相邻节点或跨模块 task

---

## 5) 图增强RAG内容生成（Graph-RAG for Teaching Output）

对话框架由图增强生成与交互管理协同完成，采用 RAG 从知识图谱检索节点与内容片段，再生成策略化输出。

### 5.1 检索层（Retrieval）

* **图检索（Neo4j）**：以“当前任务节点”为中心取 1–2 跳邻域，检索先修概念、支撑技能、前驱/后继任务
* **文本检索（chunk库）**：用节点 `canonical_name/definition` 召回相关 chunk，可使用向量检索或 BM25；召回结果按 `module_hint` 与 `objective_hint` 二次过滤

### 5.2 生成层（Generation）

将检索结果组织为“结构证据包”，输入模型生成输出，并显式对齐任务链与动作策略。证据包字段：

* `goal, current_node, prereqs, allowed_next, retrieved_excerpts, last_feedback, chosen_action`

生成结果要求同时返回：

* 教学输出文本（G–P–F 对应段落）
* 覆盖节点列表 `covered_nodes_in_output[]`
* 动作记录 `chosen_action` 与理由（用于策略标签与复现）

---

## 6) 交互管理与证据化日志（可复现实验的关键）

路径调控全程可追踪、可复核，记录触发条件、插入节点、回退位置与后续结果。日志采用 `path_log.jsonl`，每轮一条：

* `session_id, module, scenario_type, agent_type`
* `turn_id, current_node, user_input, detected_issue`
* `action_type, inserted_nodes[], backtrack_to, simplify_level`
* `covered_nodes_in_output[]`
* `timestamp, model_version, temperature`

---

## 7) 对话仿真实验实现（Simulation）

实验设计为：两模块 × 三场景 × 两智能体，每个智能体 50 次，共 100 sessions。实现采用“任务树驱动批量跑”：

* 模块：Movement Systems；Health and Aerobic Training Design
* 场景：ambiguous / misunderstanding / cross-task
* 每次仿真输入：`(module, target_task, scenario_trigger, agent_type)`
* 输出：对话文本 + 路径动作序列 + 日志（JSONL）

---

## 8) 核心指标计算（结构匹配、策略标签、目标一致性）

系统评估使用三项指标：Structural Match Degree、Strategy Tagging Extraction、Goal Alignment。

* **结构匹配度**
  [
  SMD = \frac{|V_{covered}|}{|V_{preset}|}
  ]
  其中 (|V_{covered}|) 为输出覆盖的关键节点数，(|V_{preset}|) 为任务链预设关键节点数

* **策略标签频率**
  [
  STF = \frac{N_{insert}}{N_{turn}}
  ]
  其中 (N_{insert}) 为策略插入总次数，(N_{turn}) 为交互轮次总数

* **目标一致性**（语义嵌入相似度均值）
  [
  GA = \frac{1}{n}\sum_{i=1}^{n}\cos(\mathbf{e}(y_i), \mathbf{e}(t_i))
  ]
  其中 (y_i) 为第 (i) 次输出文本，(t_i) 为目标内容或目标节点说明，(\mathbf{e}(\cdot)) 为固定版本的文本嵌入函数

---

## 9) 交付物清单（工程与论文一致）

* `KG`：Neo4j 数据库 + `kg_export.graphml/csv`（节点/边表）
* `TaskChain`：任务链模板库 + 每个模块的实例化链（JSON）
* `Agents`：Guiding/Structural 两套 system prompt + 动作集合规范
* `SimData`：100 sessions 对话与日志（JSONL）
* `Metrics`：SMD/STF/GA 统计脚本与结果表
